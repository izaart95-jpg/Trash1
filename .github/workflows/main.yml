name: CHAT

on:
  workflow_dispatch:

jobs:
  chat-ngrok-runner:
    runs-on: windows-latest
    timeout-minutes: 400

    steps:
      - name: Prepare Downloads directory
        shell: powershell
        run: |
          $dl = "$env:USERPROFILE\Downloads\chat-work"
          New-Item -ItemType Directory -Force -Path $dl
          echo "WORK_DIR=$dl" >> $env:GITHUB_ENV

      - name: Download and extract chat.zip
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -L -o chat.zip https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.zip
          Expand-Archive chat.zip -Force

          $chatDir = Get-ChildItem -Directory | Select-Object -First 1
          if (-not $chatDir) { exit 1 }

          echo "CHAT_DIR=$($chatDir.FullName)" >> $env:GITHUB_ENV
          echo "CHAT_NAME=$($chatDir.Name)" >> $env:GITHUB_ENV

      - name: Download and detect ngrok.exe
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -L -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
          Expand-Archive ngrok.zip -Force

          # Dynamically find ngrok.exe
          $ngrok = Get-ChildItem -Recurse -Filter ngrok.exe | Select-Object -First 1
          if (-not $ngrok) { Write-Error "ngrok.exe not found!"; exit 1 }

          echo "NGROK_EXE=$($ngrok.FullName)" >> $env:GITHUB_ENV
          Write-Host "Found ngrok.exe at $($ngrok.FullName)"

      - name: Run node server.js and ngrok safely
        shell: powershell
        run: |
          cd $env:CHAT_DIR

          # Start node server.js in background
          Write-Host "Starting node server.js..."
          Start-Job -Name nodeServer -ScriptBlock { cmd.exe /c "node server.js" }
          echo "NODE_STARTED=$(Get-Date)" >> $env:GITHUB_ENV

          # Wait for server to respond before starting ngrok
          $maxWait = 60  # max wait 60s
          $waited = 0
          $port = 9001
          $serverReady = $false

          while (-not $serverReady -and $waited -lt $maxWait) {
              try {
                  $resp = Invoke-WebRequest -Uri "http://localhost:$port" -UseBasicParsing -TimeoutSec 2
                  if ($resp.StatusCode -eq 200 -or $resp.StatusCode -eq 404) {
                      $serverReady = $true
                      break
                  }
              } catch {}
              Start-Sleep -Seconds 2
              $waited += 2
          }

          if (-not $serverReady) {
              Write-Error "Node server did not start within $maxWait seconds!"
              exit 1
          }
          Write-Host "Node server is ready on port $port"

          # Start ngrok once server is ready
          Write-Host "Starting ngrok http $port..."
          Start-Job -Name ngrokTunnel -ScriptBlock { cmd.exe /c "$env:NGROK_EXE http $port" }
          echo "NGROK_STARTED=$(Get-Date)" >> $env:GITHUB_ENV

      - name: Wait 5h 52m
        shell: powershell
        run: |
          $waitSeconds = (5 * 3600) + (52 * 60)
          Write-Host "Waiting $waitSeconds seconds..."
          Start-Sleep -Seconds $waitSeconds

      - name: POST delete
        shell: powershell
        run: |
          curl.exe -X POST https://abstrusely-procompensation-phuong.ngrok-free.dev/delete

      - name: Stop node & ngrok
        shell: powershell
        run: |
          Get-Job | Stop-Job -Force
          Get-Process node -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force

      - name: Zip chat folder
        shell: powershell
        run: |
          cd $env:WORK_DIR
          if (Test-Path chat.zip) { Remove-Item chat.zip -Force }
          Compress-Archive -Path $env:CHAT_NAME -DestinationPath chat.zip

      - name: Upload zip
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -X POST https://abstrusely-procompensation-phuong.ngrok-free.dev/upload `
            -F "file=@chat.zip"
