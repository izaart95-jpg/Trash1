name: Chat Automation (PAA-style)

on:
  workflow_dispatch:

jobs:
  chat-automation:
    runs-on: windows-latest
    timeout-minutes: 400

    steps:
      - name: Setup working directories
        shell: powershell
        run: |
          $base = "$env:GITHUB_WORKSPACE\work"
          $chatZip = "$base\chat.zip"
          $ngrokZip = "$base\ngrok.zip"
          $ngrokDir = "$base\ngrok"
          New-Item -ItemType Directory -Force -Path $base, $ngrokDir
          echo "BASE_DIR=$base" >> $env:GITHUB_ENV
          echo "CHAT_ZIP=$chatZip" >> $env:GITHUB_ENV
          echo "NGROK_DIR=$ngrokDir" >> $env:GITHUB_ENV

      - name: Download chat.zip (wget)
        shell: powershell
        run: |
          cd $env:BASE_DIR
          wget https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.zip -O chat.zip
          Expand-Archive chat.zip -Force

      - name: Download ngrok (wget)
        shell: powershell
        run: |
          cd $env:BASE_DIR
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -O ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath $env:NGROK_DIR -Force
          echo "NGROK_EXE=$env:NGROK_DIR\ngrok.exe" >> $env:GITHUB_ENV

      - name: Install Node dependencies
        shell: powershell
        run: |
          cd $env:BASE_DIR\chat-main
          npm install

      - name: Start npm & ngrok, wait 5h52m, cleanup & upload
        shell: powershell
        run: |
          cd $env:BASE_DIR\chat-main

          Write-Host "Starting npm start..."
          $npm = Start-Process npm -ArgumentList "start" -PassThru
          $npmStartTime = Get-Date

          Write-Host "Configuring ngrok..."
          & $env:NGROK_EXE config add-authtoken 36kAMHU3fGiD51IZZ91dX7y9QWB_4xSjCmBjUCyD2137xtnKh

          Start-Sleep -Seconds 5

          Write-Host "Starting ngrok http 9001..."
          $ngrok = Start-Process $env:NGROK_EXE -ArgumentList "http 9001" -PassThru

          # ---- WAIT 5 HOURS 52 MINUTES ----
          $targetMinutes = (5 * 60) + 52
          while ((New-TimeSpan -Start $npmStartTime -End (Get-Date)).TotalMinutes -lt $targetMinutes) {
            Start-Sleep -Seconds 60
          }

          Write-Host "Time reached: 5h52m â†’ Sending DELETE request"
          wget --method=POST https://abstrusely-procompensation-phuong.ngrok-free.dev/delete

          Write-Host "Stopping npm and ngrok..."
          Stop-Process -Id $npm.Id -Force
          Stop-Process -Id $ngrok.Id -Force

          cd $env:BASE_DIR
          if (Test-Path chat.zip) { Remove-Item chat.zip -Force }

          Write-Host "Re-zipping chat-main..."
          Compress-Archive chat-main chat.zip

          Write-Host "Uploading chat.zip..."
          wget --method=POST `
            --body-file=chat.zip `
            https://abstrusely-procompensation-phuong.ngrok-free.dev/upload

      - name: Done
        run: echo "Workflow completed successfully"
