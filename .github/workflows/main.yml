name: CHAT
on:
  workflow_dispatch:
jobs:
  chat-ngrok-runner:
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Prepare Downloads directory
        shell: powershell
        run: |
          $dl = "$env:USERPROFILE\Downloads\chat-work"
          New-Item -ItemType Directory -Force -Path $dl
          echo "WORK_DIR=$dl" >> $env:GITHUB_ENV
          # Record start time as Unix timestamp
          $startTime = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
          echo "START_TIME=$startTime" >> $env:GITHUB_ENV
          Write-Host "Workflow started at Unix timestamp: $startTime"

      - name: Download and extract chat.tar
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -L -o chat.tar https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.tar
          tar -xf chat.tar

      - name: Install npm dependencies
        shell: powershell
        run: |
          cd "$env:WORK_DIR\chat-main"
          npm install

      - name: Download ngrok.exe
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -L -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
          Expand-Archive ngrok.zip -Force
          $ngrok = Get-ChildItem -Recurse -Filter ngrok.exe | Select-Object -First 1
          echo "NGROK_EXE=$($ngrok.FullName)" >> $env:GITHUB_ENV
          Write-Host "Found ngrok.exe at $($ngrok.FullName)"

      - name: Configure ngrok auth
        shell: powershell
        run: |
          & "$env:NGROK_EXE" config add-authtoken 36kAMHU3fGiD51IZZ91dX7y9QWB_4xSjCmBjUCyD2137xtnKh

      - name: Run Node server and ngrok with timer
        shell: powershell
        run: |
          cd "$env:WORK_DIR\chat-main"
          
          # Calculate target duration: 4 minutes = 240 seconds
          $targetDuration = 5 * 60  # 240 seconds
          $startTime = [long]$env:START_TIME
          
          Write-Host "Start time: $startTime"
          Write-Host "Target duration: $targetDuration seconds (4 minutes)"
          
          # Start node directly in background using Start-Job
          $job = Start-Job -ScriptBlock {
            param($dir)
            cd $dir
            node server.js
          } -ArgumentList "$env:WORK_DIR\chat-main"
          
          Write-Host "Node server started as background job"
          Start-Sleep -Seconds 5
          
          # Verify job is running
          Get-Job | Format-Table
          
          # Start ngrok in background as well
          Write-Host "Starting ngrok tunnel in background..."
          $ngrokJob = Start-Job -ScriptBlock {
            param($ngrokPath)
            & $ngrokPath http 9001 --log=stdout
          } -ArgumentList "$env:NGROK_EXE"
          
          Start-Sleep -Seconds 10
          Write-Host "Ngrok started. Monitoring time..."
          
          # Monitor loop - check every 10 seconds (more frequent for shorter test)
          while ($true) {
            $currentTime = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
            $elapsed = $currentTime - $startTime
            $remaining = $targetDuration - $elapsed
            
            $elapsedSeconds = $elapsed
            $remainingSeconds = $remaining
            
            Write-Host "Elapsed: $elapsedSeconds seconds | Remaining: $remainingSeconds seconds"
            
            if ($elapsed -ge $targetDuration) {
              Write-Host "Time limit reached (4 minutes). Initiating shutdown..."
              break
            }
            
            # Check if jobs are still running
            $nodeStatus = Get-Job -Id $job.Id -ErrorAction SilentlyContinue
            $ngrokStatus = Get-Job -Id $ngrokJob.Id -ErrorAction SilentlyContinue
            
            if ($nodeStatus.State -eq 'Failed' -or $ngrokStatus.State -eq 'Failed') {
              Write-Host "A job has failed. Check logs."
            }
            
            Start-Sleep -Seconds 10
          }
          
          Write-Host "Stopping processes..."

      - name: Stop Node & ngrok and upload
        if: always()
        shell: powershell
        run: |
          Write-Host "Stopping Node and ngrok processes..."
          Get-Process node -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force
          
          Start-Sleep -Seconds 5
          
          Write-Host "Compressing chat-main to chat.tar..."
          cd $env:WORK_DIR
          
          # Remove old chat.tar if exists
          if (Test-Path "chat.tar") {
            Remove-Item "chat.tar" -Force
          }
          
          # Create tar archive
          tar -cvf chat.tar chat-main
          
          Write-Host "chat.tar created. Size: $((Get-Item chat.tar).Length) bytes"
          
          # Send delete request
          Write-Host "Sending delete request..."
          curl.exe -X POST https://abstrusely-procompensation-phuong.ngrok-free.dev/delete
          
          Write-Host "Waiting 15 seconds..."
          Start-Sleep -Seconds 15
          
          # Upload the new chat.tar
          Write-Host "Uploading chat.tar..."
          $tarPath = "$env:WORK_DIR\chat.tar"
          curl.exe -X POST -F "file=@$tarPath" https://abstrusely-procompensation-phuong.ngrok-free.dev/upload
          
          Write-Host "Upload complete!"
          curl.exe -X POST http://uk9heosxjd.loclx.io/trigger
          Write-Host "Sucking Complete"
