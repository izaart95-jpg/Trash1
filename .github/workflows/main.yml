name: CHAT

on:
  workflow_dispatch:

jobs:
  chat-ngrok-runner:
    runs-on: windows-latest
    timeout-minutes: 400

    steps:
      - name: Prepare workspace
        shell: powershell
        run: |
          $work = "$env:GITHUB_WORKSPACE\chat-work"
          New-Item -ItemType Directory -Force -Path $work
          echo "WORK_DIR=$work" >> $env:GITHUB_ENV

      - name: Download and extract chat.zip (auto-detect folder)
        shell: powershell
        run: |
          cd $env:WORK_DIR

          curl.exe -L -o chat.zip https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.zip
          Expand-Archive chat.zip -Force

          $chatDir = Get-ChildItem -Directory | Select-Object -First 1
          if (-not $chatDir) {
            Write-Error "No directory found after extracting chat.zip"
            exit 1
          }

          Write-Host "Detected chat directory: $($chatDir.FullName)"
          echo "CHAT_DIR=$($chatDir.FullName)" >> $env:GITHUB_ENV
          echo "CHAT_NAME=$($chatDir.Name)" >> $env:GITHUB_ENV

      - name: Download ngrok
        shell: powershell
        run: |
          cd $env:WORK_DIR

          curl.exe -L -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
          Expand-Archive ngrok.zip -Force

          $ngrok = Get-ChildItem -Recurse -Filter ngrok.exe | Select-Object -First 1
          echo "NGROK_EXE=$($ngrok.FullName)" >> $env:GITHUB_ENV

      - name: Start npm & ngrok
        shell: powershell
        run: |
          cd $env:CHAT_DIR

          Write-Host "Starting npm start..."
          $npm = Start-Process -FilePath "npm" -ArgumentList "start" -PassThru -WindowStyle Hidden
          echo "NPM_PID=$($npm.Id)" >> $env:GITHUB_ENV

          Start-Sleep -Seconds 5

          & "$env:NGROK_EXE" config add-authtoken 36kAMHU3fGiD51IZZ91dX7y9QWB_4xSjCmBjUCyD2137xtnKh
          Start-Sleep -Seconds 5
          Start-Process -FilePath "$env:NGROK_EXE" -ArgumentList "http 9001" -WindowStyle Hidden

      - name: Wait 5h 52m
        shell: powershell
        run: |
          Start-Sleep -Seconds ((5 * 3600) + (52 * 60))

      - name: POST delete
        shell: powershell
        run: |
          curl.exe -X POST https://abstrusely-procompensation-phuong.ngrok-free.dev/delete

      - name: Stop npm
        shell: powershell
        run: |
          if ($env:NPM_PID) {
            Stop-Process -Id $env:NPM_PID -Force
          }

      - name: Zip chat folder
        shell: powershell
        run: |
          cd $env:WORK_DIR
          if (Test-Path chat.zip) { Remove-Item chat.zip -Force }
          Compress-Archive -Path $env:CHAT_NAME -DestinationPath chat.zip

      - name: Upload zip
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -X POST https://abstrusely-procompensation-phuong.ngrok-free.dev/upload `
            -F "file=@chat.zip"
