name: CHAT

on:
  workflow_dispatch:

jobs:
  chat-ngrok-runner:
    runs-on: windows-latest
    timeout-minutes: 400

    steps:
      - name: Prepare Downloads directory
        shell: powershell
        run: |
          $dl = "$env:USERPROFILE\Downloads\chat-work"
          New-Item -ItemType Directory -Force -Path $dl
          echo "WORK_DIR=$dl" >> $env:GITHUB_ENV

      - name: Download and extract chat.zip
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -L -o chat.zip https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.zip
          Expand-Archive chat.zip -Force
          echo "CHAT_NAME=chat-main" >> $env:GITHUB_ENV

      - name: Download ngrok.exe and configure auth token
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -L -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
          Expand-Archive ngrok.zip -Force
          $ngrok = Get-ChildItem -Recurse -Filter ngrok.exe | Select-Object -First 1
          echo "NGROK_EXE=$($ngrok.FullName)" >> $env:GITHUB_ENV
          Write-Host "Found ngrok.exe at $($ngrok.FullName)"

          # Configure ngrok auth token
          & "$($ngrok.FullName)" config add-authtoken 36kAMHU3fGiD51IZZ91dX7y9QWB_4xSjCmBjUCyD2137xtnKh
          Write-Host "ngrok auth token configured"

      - name: Run Node server and ngrok in background
        shell: powershell
        run: |
          cd $env:WORK_DIR

          # Find server.js dynamically
          $serverFile = Get-ChildItem -Recurse -Filter server.js | Select-Object -First 1
          if (-not $serverFile) { Write-Error "server.js not found!"; exit 1 }
          Write-Host "Found server.js at $($serverFile.FullName)"

          # Start Node server in background
          $nodeProcess = Start-Process node -ArgumentList "$($serverFile.FullName)" -PassThru
          Write-Host "Node server started (PID: $($nodeProcess.Id))"

          # Give server a few seconds to start
          Start-Sleep -Seconds 5

          # Start ngrok as a job and pass full path explicitly
          $ngrokExe = "$env:NGROK_EXE"
          $ngrokJob = Start-Job -Name ngrokTunnel -ScriptBlock { param($path) & $path http 9001 } -ArgumentList $ngrokExe
          Write-Host "ngrok started as background job"

          # Wait a few seconds for ngrok to register tunnel
          Start-Sleep -Seconds 5

          # Fetch the public URL from ngrok API
          $ngrokApi = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels
          $publicUrl = $ngrokApi.tunnels[0].public_url
          Write-Host "ngrok public URL: $publicUrl"
          echo "NGROK_PUBLIC_URL=$publicUrl" >> $env:GITHUB_ENV

      - name: Wait 5h 52m
        shell: powershell
        run: |
          $waitSeconds = (5 * 3600) + (52 * 60)
          Write-Host "Waiting $waitSeconds seconds..."
          Start-Sleep -Seconds $waitSeconds

      - name: POST delete
        shell: powershell
        run: |
          curl.exe -X POST https://abstrusely-procompensation-phuong.ngrok-free.dev/delete

      - name: Stop Node & ngrok
        shell: powershell
        run: |
          Get-Job -Name ngrokTunnel | Stop-Job -Force
          Get-Process node -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Process ngrok -ErrorAction SilentlyContinue | Stop-Process -Force

      - name: Zip chat folder
        shell: powershell
        run: |
          cd $env:WORK_DIR
          if (Test-Path chat.zip) { Remove-Item chat.zip -Force }
          Compress-Archive -Path $env:CHAT_NAME -DestinationPath chat.zip

      - name: Upload zip
        shell: powershell
        run: |
          cd $env:WORK_DIR
          curl.exe -X POST https://abstrusely-procompensation-phuong.ngrok-free.dev/upload `
            -F "file=@chat.zip"
