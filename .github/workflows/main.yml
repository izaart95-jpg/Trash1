name: Chat Automation

on:
  workflow_dispatch:

jobs:
  chat-job:
    runs-on: windows-latest
    timeout-minutes: 400

    steps:
      - name: Setup working directories
        shell: powershell
        run: |
          $base = "$env:GITHUB_WORKSPACE\work"
          $chatZip = "$base\chat.zip"
          $ngrokZip = "$base\ngrok.zip"
          New-Item -ItemType Directory -Path $base -Force
          Set-Location $base
          echo "BASE_DIR=$base" >> $env:GITHUB_ENV
          echo "CHAT_ZIP=$chatZip" >> $env:GITHUB_ENV
          echo "NGROK_ZIP=$ngrokZip" >> $env:GITHUB_ENV

      - name: Download chat.zip
        shell: powershell
        run: |
          curl -L "https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.zip" -o "$env:CHAT_ZIP"
          Expand-Archive "$env:CHAT_ZIP" -DestinationPath "$env:BASE_DIR" -Force

      - name: Download ngrok
        shell: powershell
        run: |
          curl -L "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -o "$env:NGROK_ZIP"
          Expand-Archive "$env:NGROK_ZIP" -DestinationPath "$env:BASE_DIR\ngrok" -Force
          echo "NGROK_EXE=$env:BASE_DIR\ngrok\ngrok.exe" >> $env:GITHUB_ENV

      - name: Install Node dependencies
        shell: powershell
        run: |
          cd "$env:BASE_DIR\chat-main"
          npm install

      - name: Start npm, ngrok, timer logic
        shell: powershell
        run: |
          cd "$env:BASE_DIR\chat-main"

          Write-Host "Starting npm start..."
          $npm = Start-Process npm -ArgumentList "start" -PassThru

          $startTime = Get-Date
          Write-Host "npm start PID: $($npm.Id)"
          Write-Host "Start time: $startTime"

          Start-Sleep -Seconds 5

          & "$env:NGROK_EXE" config add-authtoken 36kAMHU3fGiD51IZZ91dX7y9QWB_4xSjCmBjUCyD2137xtnKh

          Start-Sleep -Seconds 5

          $ngrok = Start-Process "$env:NGROK_EXE" -ArgumentList "http 9001" -PassThru
          Write-Host "ngrok PID: $($ngrok.Id)"

          # 5 hours 52 minutes = 21120 seconds
          $targetSeconds = 21120

          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalSeconds -lt $targetSeconds) {
              Start-Sleep -Seconds 60
          }

          Write-Host "=== 5:52 elapsed, sending delete ==="
          curl -X POST "https://abstrusely-procompensation-phuong.ngrok-free.dev/delete"

          Write-Host "Stopping npm and ngrok..."
          Stop-Process -Id $npm.Id -Force
          Stop-Process -Id $ngrok.Id -Force

      - name: Zip folder again
        shell: powershell
        run: |
          cd "$env:BASE_DIR"
          if (Test-Path chat.zip) { Remove-Item chat.zip -Force }
          Compress-Archive -Path "chat-main\*" -DestinationPath "chat.zip"

      - name: Upload chat.zip
        shell: powershell
        run: |
          curl -X POST "https://abstrusely-procompensation-phuong.ngrok-free.dev/upload" `
            -F "file=@chat.zip"
